<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Speech Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Pure black background */
        }
        .visualizer-container {
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1/1;
        }
        .outer-ring {
            stroke: #f97316;
            stroke-width: 3;
            fill: none;
        }
        .waveform-part {
             fill: #f97316;
             stroke: #f97316;
             transition: all 0.05s ease-out;
        }
        .waveform-path {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
        }
        .highlight-part {
            fill: #FFD200;
            stroke: #FFD200;
        }
        .waveform-path.highlight-part {
            fill: none;
        }
        .star {
            fill: #FFFFFF;
            transform-origin: 50px 50px;
            transition: transform 0.05s ease-out;
        }
    </style>
</head>
<body class="bg-black flex flex-col items-center justify-center min-h-screen p-4 text-white">

    <div class="visualizer-container">
        <svg id="speech-visualizer" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
            
            <defs>
                <path id="star-shape" d="M50 0 L65 35 L100 50 L65 65 L50 100 L35 65 L0 50 L35 35 Z" />
            </defs>
            
            <g>
                <circle class="outer-ring" cx="150" cy="150" r="140"/>
                <g class="waveform">
                    <circle class="waveform-part highlight-part" cx="70" cy="150" r="5" />
                    <rect class="waveform-part bar" id="bar1" x="90" y="125" width="8" height="50" rx="4"/>
                    <rect class="waveform-part bar" id="bar2" x="105" y="110" width="8" height="80" rx="4"/>
                    <rect class="waveform-part bar" id="bar3" x="120" y="90" width="8" height="120" rx="4"/>
                    <rect class="waveform-part bar" id="bar4" x="135" y="70" width="8" height="160" rx="4"/>
                    <rect class="waveform-part bar" id="bar5" x="150" y="100" width="8" height="100" rx="4"/>
                    <rect class="waveform-part bar" id="bar6" x="165" y="115" width="8" height="70" rx="4"/>
                    <rect class="waveform-part bar" id="bar7" x="180" y="130" width="8" height="40" rx="4"/>
                    <path class="waveform-part waveform-path highlight-part" d="M 200 120 C 210 135, 210 165, 200 180" />
                    <path class="waveform-part waveform-path highlight-part" d="M 215 110 C 230 135, 230 165, 215 190" />
                </g>
            </g>

            <g class="stars">
                 <g class="star-group" transform="translate(195, 45) scale(0.4)">
                    <use href="#star-shape" class="star"/>
                 </g>
                 <g class="star-group" transform="translate(228, 68) scale(0.3)">
                    <use href="#star-shape" class="star"/>
                 </g>
                 <g class="star-group" transform="translate(180, 80) scale(0.25)">
                    <use href="#star-shape" class="star"/>
                 </g>
            </g>
        </svg>
    </div>

    <div id="controls" class="mt-8 text-center">
        <button id="startButton" class="bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
            Start Listening
        </button>
        <p id="message" class="mt-4 text-gray-400 text-sm max-w-xs">
            Click the button and allow microphone access to see the visualizer react to your voice.
        </p>
    </div>

    <script>
        const startButton = document.getElementById('startButton');
        const message = document.getElementById('message');
        const bars = document.querySelectorAll('.bar');
        const stars = document.querySelectorAll('.star');
        let audioContext;
        let analyser;
        let source;
        let gainNode;
        let animationFrameId;

        const initialHeights = Array.from(bars).map(bar => parseFloat(bar.getAttribute('height')));
        const svgCenterY = 150;

        let idleTime = 0;
        function idleAnimation() {
            idleTime += 0.02;
            bars.forEach((bar, index) => {
                const initialHeight = initialHeights[index];
                const noise = Math.sin(idleTime + index) * 10;
                const newHeight = Math.max(10, initialHeight + noise);
                bar.setAttribute('height', newHeight);
                bar.setAttribute('y', svgCenterY - newHeight / 2);
            });
            const starScale = 1 + Math.sin(idleTime * 2) * 0.1;
            stars.forEach(star => {
                star.style.transform = `scale(${starScale})`;
            });

            animationFrameId = requestAnimationFrame(idleAnimation);
        }

        async function startVisualizer() {
            if (audioContext && audioContext.state === 'running') return;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.8;
                
                source = audioContext.createMediaStreamSource(stream);
                
                gainNode = audioContext.createGain();
                gainNode.gain.value = 2.5;

                source.connect(gainNode);
                gainNode.connect(analyser);

                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                startButton.textContent = 'Listening...';
                startButton.disabled = true;
                message.textContent = "Speak into your microphone!";
                
                const draw = () => {
                    animationFrameId = requestAnimationFrame(draw);
                    analyser.getByteFrequencyData(dataArray);

                    const barCount = bars.length;
                    let overallAvg = 0;
                    
                    const midPoint = Math.floor(barCount / 2);
                    const step = Math.floor(bufferLength / (midPoint + 4));
                    
                    // --- NEW: Get the max initial height to create a shape ratio ---
                    const maxInitialHeight = Math.max(...initialHeights);

                    bars.forEach((bar, i) => {
                        const distanceFromCenter = Math.abs(i - midPoint);
                        
                        const sliceStart = (distanceFromCenter + 1) * step;
                        const sliceEnd = sliceStart + step;
                        let slice = dataArray.slice(sliceStart, sliceEnd);
                        
                        let avg = slice.reduce((a, b) => a + b, 0) / slice.length || 0;
                        overallAvg += avg;
                        
                        // --- UPDATED LOGIC TO ENFORCE DIAMOND SHAPE ---
                        // Calculate the maximum potential height for this specific bar based on the SVG's design
                        const maxBarHeight = (initialHeights[i] / maxInitialHeight) * 180;
                        
                        // Calculate the height based on audio, scaling it to the bar's maximum potential height
                        const height = Math.pow(avg / 255, 0.6) * maxBarHeight + 10;
                        
                        bar.setAttribute('height', height);
                        bar.setAttribute('y', svgCenterY - height / 2);
                    });
                    
                    overallAvg /= barCount;

                    const pulseScale = 0.9 + (overallAvg / 255) * 0.7;
                    stars.forEach(star => {
                         star.style.transform = `scale(${pulseScale})`;
                    });
                };

                draw();

            } catch (err) {
                console.error('Error accessing microphone:', err);
                message.textContent = 'Could not access microphone. Please check permissions and try again.';
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                idleAnimation();
            }
        }

        startButton.addEventListener('click', startVisualizer);
        window.addEventListener('load', idleAnimation);
    </script>

</body>
</html>
